#!/usr/bin/env ruby
require 'yaml'
require 'optparse'
require 'pivotal_git_scripts/git_pair'

include PivotalGitScripts::GitPair

git_dir = `git rev-parse --git-dir`.chomp
exit 1 if git_dir.empty?

options = parse_cli_options(ARGV)
initials = ARGV
config = read_pairs_config
global = " --global" if options[:global] or config["global"]

if initials.any?
  author_names, email_ids = extract_author_names_and_email_ids_from_config(config, initials)
  authors = [author_names[0..-2].join(", "), author_names.last].reject(&:empty?).join(" and ")
  git_config = {:name => authors,  :initials => initials.join(" ")}
  git_config[:email] = build_email(email_ids, config["email"]) unless no_email(config)
  set_git_config global,  git_config
else
  git_config = {:name => nil,  :initials => nil}
  git_config[:email] = nil unless no_email(config)
  set_git_config global, git_config
  puts "Unset#{global} user.name, #{'user.email, ' unless no_email(config)}user.initials"
end

[:name, :email, :initials].each do |key|
  report_git_settings(git_dir, key)
end
